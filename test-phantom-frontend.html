<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Teste Phantom - Problema de Abertura</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .test-section {
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            background: #f8f9fa;
            border-left: 4px solid #4CAF50;
        }

        .test-section.error {
            border-left-color: #f44336;
            background: #ffebee;
        }

        .test-section.warning {
            border-left-color: #ff9800;
            background: #fff3e0;
        }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .log {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }

        .status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .success {
            background: #4CAF50;
        }

        .error {
            background: #f44336;
        }

        .warning {
            background: #ff9800;
        }

        .info {
            background: #2196F3;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîç Diagn√≥stico Espec√≠fico - Phantom n√£o Abre</h1>
        <p><strong>Problema:</strong> Phantom Wallet n√£o abre para aprova√ß√£o de transa√ß√µes</p>

        <div class="test-section" id="phantom-status">
            <h3><span class="status info"></span>Status do Phantom</h3>
            <div id="phantom-info">Verificando...</div>
        </div>

        <div class="test-section">
            <h3>üß™ Testes Espec√≠ficos</h3>

            <button onclick="testPhantomDetection()">1. Detectar Phantom</button>
            <button onclick="testPhantomConnection()">2. Conectar Phantom</button>
            <button onclick="testPopupBlocker()">3. Testar Popup Blocker</button>
            <button onclick="testTransactionCreation()">4. Criar Transa√ß√£o</button>
            <button onclick="testPhantomSigning()" id="sign-btn" disabled>5. üö® TESTE CR√çTICO - Assinar
                Transa√ß√£o</button>
        </div>

        <div class="log" id="log"></div>

        <div class="test-section" id="solution-section" style="display: none;">
            <h3><span class="status warning"></span>üí° Solu√ß√µes Recomendadas</h3>
            <div id="solutions"></div>
        </div>
    </div>

    <script>
        let phantomProvider = null;
        let isConnected = false;
        let testTransaction = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff4444' : type === 'success' ? '#44ff44' : type === 'warning' ? '#ffaa44' : '#00ff00';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        // Inicializa√ß√£o
        window.addEventListener('load', () => {
            log('üöÄ Iniciando diagn√≥stico espec√≠fico do Phantom...', 'info');
            checkPhantomStatus();
        });

        function checkPhantomStatus() {
            const statusDiv = document.getElementById('phantom-info');

            if (window.solana) {
                if (window.solana.isPhantom) {
                    statusDiv.innerHTML = '‚úÖ Phantom detectado e dispon√≠vel';
                    log('‚úÖ Phantom detectado com sucesso', 'success');
                    phantomProvider = window.solana;
                } else {
                    statusDiv.innerHTML = '‚ö†Ô∏è Solana provider detectado, mas n√£o √© Phantom';
                    log('‚ö†Ô∏è Provider Solana encontrado, mas n√£o √© Phantom', 'warning');
                }
            } else {
                statusDiv.innerHTML = '‚ùå Phantom n√£o encontrado - Instale a extens√£o';
                log('‚ùå Phantom n√£o encontrado no window.solana', 'error');
                showSolutions(['phantom-not-installed']);
            }
        }

        async function testPhantomDetection() {
            log('üîç Testando detec√ß√£o do Phantom...', 'info');

            if (!window.solana) {
                log('‚ùå window.solana n√£o existe', 'error');
                return false;
            }

            if (!window.solana.isPhantom) {
                log('‚ùå window.solana.isPhantom √© false', 'error');
                return false;
            }

            log('‚úÖ Phantom detectado corretamente', 'success');
            return true;
        }

        async function testPhantomConnection() {
            log('üîó Testando conex√£o com Phantom...', 'info');

            if (!phantomProvider) {
                log('‚ùå Phantom provider n√£o dispon√≠vel', 'error');
                return false;
            }

            try {
                const response = await phantomProvider.connect();
                isConnected = true;
                log(`‚úÖ Conectado com sucesso: ${response.publicKey.toString()}`, 'success');
                document.getElementById('sign-btn').disabled = false;
                return true;
            } catch (error) {
                log(`‚ùå Erro na conex√£o: ${error.message}`, 'error');
                if (error.message.includes('User rejected')) {
                    showSolutions(['user-rejected-connection']);
                }
                return false;
            }
        }

        async function testPopupBlocker() {
            log('üö´ Testando popup blocker...', 'info');

            try {
                const popup = window.open('', '_blank', 'width=1,height=1');
                if (popup) {
                    popup.close();
                    log('‚úÖ Popups permitidos', 'success');
                    return true;
                } else {
                    log('‚ùå Popups bloqueados pelo navegador', 'error');
                    showSolutions(['popup-blocked']);
                    return false;
                }
            } catch (error) {
                log(`‚ùå Erro testando popup: ${error.message}`, 'error');
                return false;
            }
        }

        async function testTransactionCreation() {
            log('üìã Testando cria√ß√£o de transa√ß√£o...', 'info');

            if (!isConnected) {
                log('‚ùå Phantom n√£o conectado', 'error');
                return false;
            }

            try {
                const response = await fetch('http://127.0.0.1:3001/api/investment/invest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        poolId: 'test-pool-for-phantom',
                        userPublicKey: phantomProvider.publicKey.toString(),
                        solAmount: 0.01,
                        tokenA: 'SOL',
                        tokenB: 'USDC'
                    })
                });

                const data = await response.json();

                if (data.success && data.requiresSignature) {
                    testTransaction = data.data.transactionData;
                    log('‚úÖ Transa√ß√£o criada com sucesso', 'success');
                    log(`üìù Transa√ß√£o requer assinatura: ${data.message}`, 'info');
                    return true;
                } else {
                    log(`‚ùå Erro criando transa√ß√£o: ${data.error}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Erro na API: ${error.message}`, 'error');
                return false;
            }
        }

        async function testPhantomSigning() {
            log('üö® TESTE CR√çTICO: Tentando assinar transa√ß√£o...', 'warning');
            log('‚è∞ Aguardando Phantom abrir (timeout: 30s)...', 'info');

            if (!testTransaction) {
                log('‚ùå Nenhuma transa√ß√£o dispon√≠vel para assinar', 'error');
                return;
            }

            try {
                // Simular uma transa√ß√£o b√°sica para teste
                const { Connection, PublicKey, Transaction, SystemProgram } = window.solanaWeb3;

                const connection = new Connection('https://api.mainnet-beta.solana.com');
                const transaction = new Transaction().add(
                    SystemProgram.transfer({
                        fromPubkey: phantomProvider.publicKey,
                        toPubkey: new PublicKey('11111111111111111111111111111112'),
                        lamports: 1000 // 0.000001 SOL
                    })
                );

                const { blockhash } = await connection.getRecentBlockhash();
                transaction.recentBlockhash = blockhash;
                transaction.feePayer = phantomProvider.publicKey;

                log('üì§ Enviando transa√ß√£o para Phantom...', 'info');

                // ESTE √â O MOMENTO CR√çTICO - O PHANTOM DEVE ABRIR AQUI
                const startTime = Date.now();

                const signedTransaction = await phantomProvider.signTransaction(transaction);

                const endTime = Date.now();
                const duration = (endTime - startTime) / 1000;

                log(`‚úÖ SUCESSO! Phantom abriu e transa√ß√£o foi assinada em ${duration}s`, 'success');
                log('üéâ PROBLEMA RESOLVIDO - Phantom est√° funcionando!', 'success');

            } catch (error) {
                const errorMsg = error.message || error.toString();
                log(`‚ùå FALHA CR√çTICA: ${errorMsg}`, 'error');

                if (errorMsg.includes('User rejected')) {
                    log('‚ÑπÔ∏è Usu√°rio cancelou - Phantom abriu mas foi rejeitado', 'warning');
                    showSolutions(['user-rejected-transaction']);
                } else if (errorMsg.includes('timeout') || errorMsg.includes('Timeout')) {
                    log('‚è∞ TIMEOUT - Phantom n√£o abriu dentro do tempo limite', 'error');
                    showSolutions(['phantom-timeout']);
                } else {
                    log('üîß Erro desconhecido - Phantom pode estar travado', 'error');
                    showSolutions(['phantom-stuck']);
                }
            }
        }

        function showSolutions(problemTypes) {
            const solutionSection = document.getElementById('solution-section');
            const solutionsDiv = document.getElementById('solutions');

            const solutions = {
                'phantom-not-installed': '1. Instale a extens√£o Phantom Wallet<br>2. Reinicie o navegador<br>3. Verifique se est√° habilitada',
                'user-rejected-connection': '1. Clique em "Conectar" no Phantom<br>2. Autorize a conex√£o com o site<br>3. Verifique se o site est√° na lista de sites confi√°veis',
                'user-rejected-transaction': '1. Clique em "Aprovar" no Phantom<br>2. Verifique o valor da transa√ß√£o<br>3. Certifique-se de ter saldo suficiente',
                'popup-blocked': '1. Desabilite o popup blocker<br>2. Adicione o site √†s exce√ß√µes<br>3. Teste em modo inc√≥gnito',
                'phantom-timeout': '1. Reinicie a extens√£o Phantom<br>2. Feche e abra o navegador<br>3. Teste em uma nova aba<br>4. Verifique se h√° outras abas do Phantom abertas',
                'phantom-stuck': '1. Desabilite e reabilite a extens√£o<br>2. Limpe o cache do navegador<br>3. Atualize o Phantom<br>4. Reinicie o computador se necess√°rio'
            };

            let solutionHtml = '';
            problemTypes.forEach(type => {
                if (solutions[type]) {
                    solutionHtml += `<div style="margin: 10px 0;"><strong>Solu√ß√£o:</strong><br>${solutions[type]}</div>`;
                }
            });

            solutionsDiv.innerHTML = solutionHtml;
            solutionSection.style.display = 'block';
        }
    </script>

    <!-- Carregar Solana Web3.js -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
</body>

</html>