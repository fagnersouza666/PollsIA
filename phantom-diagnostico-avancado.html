<!DOCTYPE html>
<html>
<head>
    <title>üîç Diagn√≥stico Avan√ßado - Por que Phantom n√£o abre?</title>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 8px; font-family: monospace; max-height: 300px; overflow-y: scroll; }
        .button { padding: 12px 24px; margin: 8px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }
        .button:hover { background: #4f46e5; }
        .button:disabled { background: #9ca3af; cursor: not-allowed; }
        .error { color: #dc2626; }
        .success { color: #059669; }
        .warning { color: #d97706; }
        .info { color: #2563eb; }
        .step { background: #e0e7ff; padding: 12px; margin: 8px 0; border-left: 4px solid #6366f1; }
    </style>
</head>
<body>
    <h1>üîç Diagn√≥stico Avan√ßado: Por que Phantom n√£o abre?</h1>
    
    <div class="step">
        <strong>OBJETIVO:</strong> Identificar exatamente por que o Phantom n√£o est√° abrindo a janela de assinatura.
    </div>
    
    <h2>üß™ Testes Diagn√≥sticos</h2>
    
    <button class="button" onclick="testeCompleto()">üöÄ EXECUTAR DIAGN√ìSTICO COMPLETO</button>
    <button class="button" onclick="clearLog()">üóëÔ∏è Limpar Logs</button>
    
    <div id="statusGeral" class="step">
        Status: Aguardando in√≠cio do diagn√≥stico...
    </div>
    
    <div class="log" id="logDiagnostico"></div>
    
    <h2>üìã Poss√≠veis Problemas e Solu√ß√µes</h2>
    <div id="diagnosticos" style="display: none;">
        <div class="step">
            <h3>üîç Resultados do Diagn√≥stico:</h3>
            <ul id="resultadosList"></ul>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('logDiagnostico');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logDiv.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(message) {
            document.getElementById('statusGeral').innerHTML = `<strong>Status:</strong> ${message}`;
        }

        function clearLog() {
            document.getElementById('logDiagnostico').innerHTML = '';
            document.getElementById('diagnosticos').style.display = 'none';
        }

        function addDiagnostico(problema, solucao) {
            const list = document.getElementById('resultadosList');
            list.innerHTML += `<li><strong>${problema}:</strong> ${solucao}</li>`;
            document.getElementById('diagnosticos').style.display = 'block';
        }

        async function testeCompleto() {
            clearLog();
            log('üî¨ INICIANDO DIAGN√ìSTICO AVAN√áADO DO PHANTOM', 'info');
            log('=' * 60, 'info');
            
            const problemas = [];
            let phantomFuncional = false;
            
            try {
                // TESTE 1: Verifica√ß√£o b√°sica do Phantom
                log('1Ô∏è‚É£ TESTE: Detec√ß√£o do Phantom', 'info');
                updateStatus('Verificando instala√ß√£o do Phantom...');
                
                if (!window.solana) {
                    log('‚ùå FALHA: window.solana n√£o existe', 'error');
                    problemas.push('Phantom n√£o instalado');
                    addDiagnostico('Phantom n√£o instalado', 'Instale a extens√£o Phantom em https://phantom.app');
                    return;
                }
                
                if (!window.solana.isPhantom) {
                    log('‚ùå FALHA: window.solana.isPhantom √© false', 'error');
                    problemas.push('Solana object inv√°lido');
                    addDiagnostico('Object Solana inv√°lido', 'Reinstale a extens√£o Phantom');
                    return;
                }
                
                log('‚úÖ SUCESSO: Phantom detectado corretamente', 'success');
                
                // TESTE 2: Verifica√ß√£o das fun√ß√µes necess√°rias
                log('2Ô∏è‚É£ TESTE: Fun√ß√µes dispon√≠veis', 'info');
                
                const funcoesNecessarias = ['connect', 'signTransaction', 'signAllTransactions'];
                for (const funcao of funcoesNecessarias) {
                    if (typeof window.solana[funcao] === 'function') {
                        log(`‚úÖ ${funcao}: Dispon√≠vel`, 'success');
                    } else {
                        log(`‚ùå ${funcao}: N√ÉO DISPON√çVEL`, 'error');
                        problemas.push(`Fun√ß√£o ${funcao} n√£o dispon√≠vel`);
                    }
                }
                
                // TESTE 3: Teste de conex√£o
                log('3Ô∏è‚É£ TESTE: Conex√£o com Phantom', 'info');
                updateStatus('Testando conex√£o...');
                
                let conectado = false;
                try {
                    if (!window.solana.isConnected) {
                        log('üîÑ Solicitando conex√£o...', 'info');
                        const response = await window.solana.connect();
                        log(`‚úÖ CONECTADO: ${response.publicKey.toString()}`, 'success');
                        conectado = true;
                    } else {
                        log(`‚úÖ J√Å CONECTADO: ${window.solana.publicKey.toString()}`, 'success');
                        conectado = true;
                    }
                } catch (connectError) {
                    log(`‚ùå ERRO NA CONEX√ÉO: ${connectError.message}`, 'error');
                    problemas.push('Falha na conex√£o');
                    addDiagnostico('Falha na conex√£o', 'Verifique se o Phantom est√° desbloqueado e tente novamente');
                    return;
                }
                
                // TESTE 4: Verifica√ß√£o de pop-ups
                log('4Ô∏è‚É£ TESTE: Bloqueador de pop-ups', 'info');
                
                try {
                    const testWindow = window.open('', '_blank', 'width=1,height=1');
                    if (testWindow) {
                        testWindow.close();
                        log('‚úÖ Pop-ups permitidos', 'success');
                    } else {
                        log('‚ùå Pop-ups BLOQUEADOS', 'warning');
                        problemas.push('Pop-ups bloqueados');
                        addDiagnostico('Pop-ups bloqueados', 'Permita pop-ups para este site nas configura√ß√µes do navegador');
                    }
                } catch (popupError) {
                    log('‚ö†Ô∏è Teste de pop-up falhou', 'warning');
                }
                
                // TESTE 5: Teste cr√≠tico - Cria√ß√£o e assinatura de transa√ß√£o
                log('5Ô∏è‚É£ TESTE CR√çTICO: Assinatura de transa√ß√£o', 'info');
                updateStatus('Preparando transa√ß√£o de teste...');
                
                try {
                    // Criar conex√£o com Solana
                    log('üîÑ Conectando com rede Solana...', 'info');
                    const connection = new solanaWeb3.Connection('https://api.mainnet-beta.solana.com', 'confirmed');
                    
                    // Obter blockhash recente
                    log('üîÑ Obtendo blockhash...', 'info');
                    const { blockhash } = await connection.getLatestBlockhash();
                    log(`‚úÖ Blockhash obtido: ${blockhash.slice(0, 8)}...`, 'success');
                    
                    // Criar transa√ß√£o
                    log('üîÑ Criando transa√ß√£o de teste...', 'info');
                    const transaction = new solanaWeb3.Transaction({
                        feePayer: window.solana.publicKey,
                        blockhash: blockhash,
                    });
                    
                    // Adicionar instru√ß√£o memo (mais segura para teste)
                    transaction.add(
                        new solanaWeb3.TransactionInstruction({
                            keys: [],
                            programId: new solanaWeb3.PublicKey('MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr'),
                            data: Buffer.from('PollsIA Phantom Test', 'utf8'),
                        })
                    );
                    
                    log(`‚úÖ Transa√ß√£o criada com ${transaction.instructions.length} instru√ß√£o(√µes)`, 'success');
                    
                    // MOMENTO CR√çTICO: Tentar assinar
                    log('üö® MOMENTO CR√çTICO: Solicitando assinatura...', 'warning');
                    log('‚ö†Ô∏è O PHANTOM DEVE ABRIR UMA JANELA AGORA!', 'warning');
                    log('‚è∞ Aguardando intera√ß√£o do usu√°rio...', 'info');
                    
                    updateStatus('üö® AGUARDANDO ASSINATURA NO PHANTOM...');
                    
                    const startTime = Date.now();
                    
                    try {
                        const signedTransaction = await window.solana.signTransaction(transaction);
                        const endTime = Date.now();
                        const tempoResposta = ((endTime - startTime) / 1000).toFixed(2);
                        
                        log(`üéâ SUCESSO TOTAL! Transa√ß√£o assinada em ${tempoResposta}s`, 'success');
                        log(`üìù Assinaturas: ${signedTransaction.signatures.length}`, 'success');
                        log(`üìã Primeira assinatura: ${signedTransaction.signatures[0].signature ? 'V√°lida' : 'Inv√°lida'}`, 'success');
                        
                        phantomFuncional = true;
                        addDiagnostico('‚úÖ Phantom Funcionando', 'O Phantom est√° funcionando perfeitamente! O problema pode estar no seu c√≥digo.');
                        
                    } catch (signError) {
                        const endTime = Date.now();
                        const tempoResposta = ((endTime - startTime) / 1000).toFixed(2);
                        
                        log(`‚ùå FALHA NA ASSINATURA ap√≥s ${tempoResposta}s`, 'error');
                        log(`üîç Erro: ${signError.message}`, 'error');
                        log(`üîç C√≥digo: ${signError.code || 'N/A'}`, 'error');
                        log(`üîç Tipo: ${signError.constructor.name}`, 'error');
                        
                        // An√°lise detalhada do erro
                        if (signError.code === 4001 || signError.message.includes('rejected') || signError.message.includes('cancelled')) {
                            log('‚úÖ DIAGN√ìSTICO: Phantom ABRIU mas usu√°rio cancelou', 'success');
                            addDiagnostico('Phantom abre mas usu√°rio cancela', 'O Phantom est√° funcionando! Certifique-se de aprovar a transa√ß√£o.');
                            phantomFuncional = true;
                        } else if (signError.message.includes('timeout')) {
                            log('‚ö†Ô∏è DIAGN√ìSTICO: Timeout na assinatura', 'warning');
                            addDiagnostico('Timeout na assinatura', 'Phantom pode estar lento. Tente aumentar o timeout.');
                        } else if (signError.message.includes('popup')) {
                            log('‚ùå DIAGN√ìSTICO: Problema com pop-up', 'error');
                            addDiagnostico('Problema com pop-up', 'Phantom n√£o consegue abrir janela. Verifique bloqueadores.');
                        } else {
                            log('‚ùå DIAGN√ìSTICO: Erro t√©cnico desconhecido', 'error');
                            addDiagnostico('Erro t√©cnico', `Erro: ${signError.message}. Tente reinstalar Phantom.`);
                        }
                    }
                    
                } catch (transactionError) {
                    log(`‚ùå ERRO CR√çTICO na prepara√ß√£o: ${transactionError.message}`, 'error');
                    problemas.push('Falha na cria√ß√£o da transa√ß√£o');
                    addDiagnostico('Falha t√©cnica', 'Erro na cria√ß√£o da transa√ß√£o. Verifique conex√£o com Solana.');
                }
                
                // TESTE 6: Verifica√ß√µes finais
                log('6Ô∏è‚É£ VERIFICA√á√ïES FINAIS', 'info');
                
                // Verificar vers√£o do Phantom
                if (window.solana._metadata) {
                    log(`‚ÑπÔ∏è Vers√£o Phantom: ${JSON.stringify(window.solana._metadata)}`, 'info');
                }
                
                // Verificar eventos
                if (window.solana.on) {
                    log('‚úÖ Sistema de eventos dispon√≠vel', 'success');
                } else {
                    log('‚ùå Sistema de eventos n√£o dispon√≠vel', 'error');
                }
                
            } catch (erroGeral) {
                log(`‚ùå ERRO GERAL: ${erroGeral.message}`, 'error');
                addDiagnostico('Erro geral', 'Erro inesperado no diagn√≥stico. Verifique console do navegador.');
            }
            
            // RESUMO FINAL
            log('=' * 60, 'info');
            log('üìä RESUMO DO DIAGN√ìSTICO:', 'info');
            
            if (phantomFuncional) {
                log('üéâ RESULTADO: Phantom est√° FUNCIONANDO!', 'success');
                log('üí° O problema pode estar no seu c√≥digo de integra√ß√£o.', 'info');
                updateStatus('‚úÖ Phantom funcionando! Problema pode estar no c√≥digo.');
            } else if (problemas.length === 0) {
                log('‚ö†Ô∏è RESULTADO: Diagn√≥stico inconclusivo', 'warning');
                updateStatus('‚ö†Ô∏è Diagn√≥stico inconclusivo - tente novamente');
            } else {
                log(`‚ùå RESULTADO: ${problemas.length} problema(s) encontrado(s)`, 'error');
                log(`üîß Problemas: ${problemas.join(', ')}`, 'error');
                updateStatus(`‚ùå ${problemas.length} problemas encontrados`);
            }
            
            log('üîö DIAGN√ìSTICO CONCLU√çDO', 'info');
        }

        // Auto-check na inicializa√ß√£o
        window.addEventListener('load', () => {
            log('üöÄ Diagn√≥stico carregado e pronto', 'info');
            log('üëÜ Clique em "EXECUTAR DIAGN√ìSTICO COMPLETO" para come√ßar', 'info');
        });
    </script>
</body>
</html>