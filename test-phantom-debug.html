<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Phantom Wallet Investimento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8">üîç Debug Phantom Investimento</h1>
        
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Status da Conex√£o</h2>
            
            <div id="phantomStatus" class="mb-4 p-3 rounded bg-gray-100">
                Verificando Phantom...
            </div>
            
            <div id="walletInfo" class="hidden mb-4 p-3 bg-blue-50 rounded">
                <p><strong>Endere√ßo:</strong> <span id="walletAddress"></span></p>
                <p><strong>Conectado:</strong> <span id="connectionStatus"></span></p>
            </div>
            
            <div class="space-y-3">
                <button 
                    id="connectBtn" 
                    onclick="testConnect()" 
                    class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-4 rounded-lg transition-colors"
                >
                    1. Conectar Phantom
                </button>
                
                <button 
                    id="prepareBtn" 
                    onclick="testPrepareTransaction()" 
                    disabled
                    class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium py-3 px-4 rounded-lg transition-colors"
                >
                    2. Preparar Transa√ß√£o (Mock)
                </button>
                
                <button 
                    id="signBtn" 
                    onclick="testSignTransaction()" 
                    disabled
                    class="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white font-medium py-3 px-4 rounded-lg transition-colors"
                >
                    3. Assinar Transa√ß√£o (PHANTOM DEVE ABRIR)
                </button>
                
                <button 
                    onclick="clearLogs()" 
                    class="w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-colors"
                >
                    Limpar Logs
                </button>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Logs de Debug</h2>
            <div id="logs" class="bg-gray-900 text-green-400 p-4 rounded text-sm font-mono max-h-96 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        let walletConnected = false;
        let mockTransaction = null;

        function log(message) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.innerHTML += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('phantomStatus');
            status.textContent = message;
            status.className = `mb-4 p-3 rounded ${
                type === 'success' ? 'bg-green-100 text-green-800' :
                type === 'error' ? 'bg-red-100 text-red-800' :
                'bg-gray-100 text-gray-800'
            }`;
        }

        function updateButtons() {
            document.getElementById('prepareBtn').disabled = !walletConnected;
            document.getElementById('signBtn').disabled = !walletConnected || !mockTransaction;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        async function testConnect() {
            try {
                log('üîÑ Testando conex√£o Phantom...');
                
                if (!window.solana) {
                    throw new Error('Phantom n√£o detectado');
                }

                if (!window.solana.isPhantom) {
                    throw new Error('N√£o √© um Phantom v√°lido');
                }

                log('‚úÖ Phantom detectado, solicitando conex√£o...');
                const response = await window.solana.connect();
                
                log(`‚úÖ Conectado! Endere√ßo: ${response.publicKey.toString()}`);
                
                // Mostrar info da carteira
                document.getElementById('walletAddress').textContent = 
                    response.publicKey.toString().slice(0, 4) + '...' + response.publicKey.toString().slice(-4);
                document.getElementById('connectionStatus').textContent = 'Conectado';
                document.getElementById('walletInfo').classList.remove('hidden');
                
                updateStatus('Phantom conectado com sucesso!', 'success');
                walletConnected = true;
                updateButtons();

            } catch (error) {
                log(`‚ùå Erro na conex√£o: ${error.message}`);
                updateStatus(`Erro: ${error.message}`, 'error');
                walletConnected = false;
                updateButtons();
            }
        }

        async function testPrepareTransaction() {
            try {
                log('üîÑ Criando transa√ß√£o mock para teste...');
                
                if (!window.solana || !window.solana.publicKey) {
                    throw new Error('Phantom n√£o conectado');
                }

                // Criar uma transa√ß√£o simples para teste
                const connection = new solanaWeb3.Connection('https://api.mainnet-beta.solana.com');
                const { blockhash } = await connection.getLatestBlockhash();
                
                const transaction = new solanaWeb3.Transaction({
                    feePayer: window.solana.publicKey,
                    blockhash: blockhash,
                });

                // Adicionar uma instru√ß√£o simples (memo)
                transaction.add(
                    new solanaWeb3.TransactionInstruction({
                        keys: [],
                        programId: new solanaWeb3.PublicKey('MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr'),
                        data: Buffer.from('Teste PollsIA - Phantom Debug', 'utf8'),
                    })
                );

                mockTransaction = transaction;
                log('‚úÖ Transa√ß√£o mock criada com sucesso');
                log(`üìù Transa√ß√£o tem ${transaction.instructions.length} instru√ß√£o(√µes)`);
                log(`üîó Blockhash: ${blockhash}`);
                
                updateButtons();

            } catch (error) {
                log(`‚ùå Erro ao criar transa√ß√£o: ${error.message}`);
                mockTransaction = null;
                updateButtons();
            }
        }

        async function testSignTransaction() {
            try {
                if (!mockTransaction) {
                    throw new Error('Nenhuma transa√ß√£o preparada');
                }

                log('üîÑ Iniciando teste de assinatura...');
                log('‚ö†Ô∏è ATEN√á√ÉO: O Phantom DEVE abrir uma janela agora!');
                
                if (!window.solana.isConnected) {
                    throw new Error('Phantom n√£o est√° conectado');
                }

                log('üìù Chamando window.solana.signTransaction()...');
                
                // Esta linha DEVE abrir o Phantom
                const signedTransaction = await window.solana.signTransaction(mockTransaction);
                
                log('‚úÖ SUCESSO! Transa√ß√£o assinada pelo Phantom');
                log(`üìù Assinatura: ${signedTransaction.signatures[0].signature ? 'Presente' : 'Ausente'}`);
                log(`üîç N√∫mero de assinaturas: ${signedTransaction.signatures.length}`);
                
                updateStatus('Transa√ß√£o assinada com sucesso!', 'success');

            } catch (error) {
                log(`‚ùå Erro na assinatura: ${error.message}`);
                log(`üîç Tipo do erro: ${error.constructor.name}`);
                log(`üîç C√≥digo do erro: ${error.code || 'N/A'}`);
                
                if (error.code === 4001) {
                    log('‚ÑπÔ∏è Erro 4001 = Usu√°rio rejeitou a assinatura');
                } else if (error.message.includes('User rejected')) {
                    log('‚ÑπÔ∏è Usu√°rio rejeitou a assinatura');
                } else {
                    log('‚ö†Ô∏è Erro t√©cnico na assinatura');
                }
                
                updateStatus(`Erro na assinatura: ${error.message}`, 'error');
            }
        }

        // Auto-verificar quando a p√°gina carrega
        window.addEventListener('load', () => {
            log('üöÄ P√°gina carregada - Debug Phantom Investimento');
            
            if (window.solana) {
                if (window.solana.isPhantom) {
                    log('‚úÖ Phantom detectado automaticamente');
                    updateStatus('Phantom detectado e pronto!', 'success');
                    
                    if (window.solana.isConnected) {
                        log('‚úÖ Phantom j√° estava conectado');
                        walletConnected = true;
                        updateButtons();
                    }
                } else {
                    log('‚ùå window.solana existe mas n√£o √© Phantom');
                    updateStatus('Objeto solana detectado mas n√£o √© Phantom', 'error');
                }
            } else {
                log('‚ùå window.solana n√£o encontrado');
                updateStatus('Phantom n√£o detectado. Instale em https://phantom.app', 'error');
            }
        });

        // Detectar eventos do Phantom
        if (window.solana) {
            window.solana.on('connect', () => {
                log('üîó Evento: Phantom conectado');
                walletConnected = true;
                updateButtons();
            });

            window.solana.on('disconnect', () => {
                log('üîå Evento: Phantom desconectado');
                walletConnected = false;
                updateButtons();
            });
        }
    </script>
</body>
</html>