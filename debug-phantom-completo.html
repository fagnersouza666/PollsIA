<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Debug Phantom Completo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .test-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .log-container {
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .test-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e0e0e0;
        }
        
        .result-success { color: green; margin-top: 10px; }
        .result-error { color: red; margin-top: 10px; }
        .result-warning { color: orange; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Debug Phantom Completo</h1>
            <p>Investiga√ß√£o avan√ßada dos problemas de aprova√ß√£o de transa√ß√µes</p>
        </div>

        <!-- Status do Sistema -->
        <div class="test-card">
            <h3>üìä Status do Sistema</h3>
            <div id="system-status">Inicializando...</div>
        </div>

        <!-- Testes Individuais -->
        <div class="test-grid">
            <div class="test-card">
                <h4>üîå Detec√ß√£o Phantom</h4>
                <button class="test-button" onclick="testPhantomDetection()">Testar</button>
                <div id="detection-result"></div>
            </div>

            <div class="test-card">
                <h4>ÔøΩÔøΩ Conex√£o</h4>
                <button class="test-button" onclick="testConnection()">Conectar</button>
                <div id="connection-result"></div>
            </div>

            <div class="test-card">
                <h4>üîê Transa√ß√£o</h4>
                <button class="test-button" onclick="testTransaction()">Criar</button>
                <div id="transaction-result"></div>
            </div>

            <div class="test-card">
                <h4>‚úçÔ∏è Assinatura CR√çTICA</h4>
                <button class="test-button" onclick="testSigning()" id="sign-btn" disabled>Assinar</button>
                <div id="signing-result"></div>
            </div>

            <div class="test-card">
                <h4>ü™ü Popups</h4>
                <button class="test-button" onclick="testPopups()">Testar</button>
                <div id="popup-result"></div>
            </div>

            <div class="test-card">
                <h4>üåê Backend</h4>
                <button class="test-button" onclick="testBackend()">Verificar</button>
                <div id="backend-result"></div>
            </div>
        </div>

        <!-- Teste Cr√≠tico -->
        <div style="text-align: center; margin: 30px 0;">
            <button class="test-button" onclick="runCriticalTest()" style="font-size: 18px; padding: 15px 30px; background: linear-gradient(45deg, #ff6b35, #f7931e);">
                üö® TESTE CR√çTICO DE ASSINATURA
            </button>
        </div>

        <!-- Log -->
        <div class="test-card">
            <h3>üìù Log de Debug</h3>
            <div class="log-container" id="debug-log">
                [INIT] Sistema de debug inicializado
            </div>
        </div>
    </div>

    <script>
        let logs = [];
        let connectedKey = null;

        function log(msg) {
            const time = new Date().toLocaleTimeString();
            const entry = `[${time}] ${msg}`;
            logs.push(entry);
            
            document.getElementById('debug-log').innerHTML = logs.join('\n');
            document.getElementById('debug-log').scrollTop = document.getElementById('debug-log').scrollHeight;
            
            console.log(entry);
        }

        function updateSystemStatus() {
            const phantom = window.solana;
            const status = {
                phantom: !!phantom?.isPhantom,
                connected: phantom?.isConnected || false,
                version: phantom?._version || 'N/A',
                publicKey: phantom?.publicKey?.toString() || 'N/A'
            };

            document.getElementById('system-status').innerHTML = `
                <strong>üîç Phantom Detectado:</strong> ${status.phantom ? '‚úÖ SIM' : '‚ùå N√ÉO'}<br>
                <strong>üîó Conectado:</strong> ${status.connected ? '‚úÖ SIM' : '‚ùå N√ÉO'}<br>
                <strong>üì¶ Vers√£o:</strong> ${status.version}<br>
                <strong>üîë Chave:</strong> ${status.publicKey !== 'N/A' ? status.publicKey.substring(0, 20) + '...' : 'N/A'}<br>
                <strong>üïê √öltima Verifica√ß√£o:</strong> ${new Date().toLocaleTimeString()}
            `;
        }

        async function testPhantomDetection() {
            log('üîç TESTE 1: Verificando detec√ß√£o do Phantom...');
            
            try {
                if (!window.solana) {
                    throw new Error('window.solana n√£o encontrado - Phantom n√£o instalado');
                }

                if (!window.solana.isPhantom) {
                    throw new Error('isPhantom = false - N√£o √© o Phantom Wallet');
                }

                const methods = ['connect', 'disconnect', 'signTransaction', 'signAllTransactions'];
                const missing = methods.filter(m => !window.solana[m]);
                
                if (missing.length > 0) {
                    throw new Error(`M√©todos ausentes: ${missing.join(', ')}`);
                }

                document.getElementById('detection-result').innerHTML = `
                    <div class="result-success">
                        ‚úÖ Phantom detectado com sucesso<br>
                        üìç Vers√£o: ${window.solana._version || 'Desconhecida'}<br>
                        üîß M√©todos dispon√≠veis: ${methods.length}
                    </div>
                `;

                log('‚úÖ TESTE 1 PASSOU: Phantom detectado corretamente');
                return true;

            } catch (error) {
                document.getElementById('detection-result').innerHTML = `
                    <div class="result-error">
                        ‚ùå FALHA: ${error.message}<br>
                        üí° Instale a extens√£o Phantom Wallet
                    </div>
                `;

                log(`‚ùå TESTE 1 FALHOU: ${error.message}`);
                return false;
            }
        }

        async function testConnection() {
            log('üîó TESTE 2: Testando conex√£o com Phantom...');
            
            try {
                if (!window.solana?.isPhantom) {
                    throw new Error('Phantom n√£o detectado');
                }

                log('üì° Solicitando conex√£o...');
                const result = await window.solana.connect();
                
                if (!result?.publicKey) {
                    throw new Error('Conex√£o retornou resultado inv√°lido');
                }

                connectedKey = result.publicKey.toString();

                document.getElementById('connection-result').innerHTML = `
                    <div class="result-success">
                        ‚úÖ Conectado com sucesso<br>
                        üîë Chave: ${connectedKey.substring(0, 15)}...<br>
                        üìä Status: Ativo
                    </div>
                `;

                // Habilitar teste de assinatura
                document.getElementById('sign-btn').disabled = false;
                
                log(`‚úÖ TESTE 2 PASSOU: Conectado - ${connectedKey}`);
                updateSystemStatus();
                return true;

            } catch (error) {
                document.getElementById('connection-result').innerHTML = `
                    <div class="result-error">
                        ‚ùå FALHA: ${error.message}<br>
                        üí° Desbloqueie o Phantom e tente novamente
                    </div>
                `;

                log(`‚ùå TESTE 2 FALHOU: ${error.message}`);
                return false;
            }
        }

        async function testTransaction() {
            log('üîê TESTE 3: Testando cria√ß√£o de transa√ß√£o...');
            
            try {
                if (!connectedKey) {
                    throw new Error('Phantom n√£o est√° conectado');
                }

                log('üì° Enviando requisi√ß√£o para backend...');

                const response = await fetch('http://localhost:3001/api/investment/invest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        poolId: 'debug-test-pool',
                        userPublicKey: connectedKey,
                        solAmount: 0.001, // Valor m√≠nimo para teste
                        tokenA: 'SOL',
                        tokenB: 'USDC',
                        slippage: 1.0
                    })
                });

                if (!response.ok) {
                    throw new Error(`API retornou ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Falha na API');
                }

                document.getElementById('transaction-result').innerHTML = `
                    <div class="result-success">
                        ‚úÖ Transa√ß√£o criada com sucesso<br>
                        üìÑ Requer assinatura: ${result.requiresSignature ? 'SIM' : 'N√ÉO'}<br>
                        üí∞ Valor: ${result.actualSolSpent || 'N/A'} SOL<br>
                        üìù Descri√ß√£o: ${result.description || 'N/A'}
                    </div>
                `;

                log('‚úÖ TESTE 3 PASSOU: Transa√ß√£o criada via API');
                return result;

            } catch (error) {
                document.getElementById('transaction-result').innerHTML = `
                    <div class="result-error">
                        ‚ùå FALHA: ${error.message}<br>
                        üí° Verifique se o backend est√° rodando na porta 3001
                    </div>
                `;

                log(`‚ùå TESTE 3 FALHOU: ${error.message}`);
                return false;
            }
        }

        async function testSigning() {
            log('‚úçÔ∏è TESTE 4: Testando assinatura - CR√çTICO...');
            
            try {
                if (!window.solana?.isConnected) {
                    throw new Error('Phantom n√£o est√° conectado');
                }

                log('üö® INICIANDO TESTE CR√çTICO DE ASSINATURA');
                log('‚ö†Ô∏è O Phantom DEVE abrir agora para aprova√ß√£o!');

                // Criar interface visual para o usu√°rio
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    z-index: 10000;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                `;

                const modal = document.createElement('div');
                modal.style.cssText = `
                    background: white;
                    padding: 40px;
                    border-radius: 20px;
                    text-align: center;
                    max-width: 500px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                `;

                modal.innerHTML = `
                    <h2>üîê TESTE CR√çTICO DE ASSINATURA</h2>
                    <p style="margin: 20px 0; font-size: 16px;">
                        Clique no bot√£o abaixo para testar se o Phantom abre corretamente para assinatura.
                    </p>
                    <button id="critical-sign-btn" style="
                        background: linear-gradient(45deg, #ff6b35, #f7931e);
                        color: white;
                        border: none;
                        padding: 20px 40px;
                        border-radius: 15px;
                        font-size: 18px;
                        font-weight: bold;
                        cursor: pointer;
                        margin: 20px;
                        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
                        animation: pulse 2s infinite;
                    ">
                        üîê ASSINAR TRANSA√á√ÉO DE TESTE
                    </button>
                    <div id="signing-status" style="margin-top: 20px; font-weight: bold;"></div>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        background: #ccc;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 5px;
                        margin-top: 20px;
                        cursor: pointer;
                    ">
                        Cancelar
                    </button>
                `;

                // Adicionar anima√ß√£o
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes pulse {
                        0% { transform: scale(1); }
                        50% { transform: scale(1.05); }
                        100% { transform: scale(1); }
                    }
                `;
                document.head.appendChild(style);

                overlay.appendChild(modal);
                document.body.appendChild(overlay);

                const result = await new Promise((resolve, reject) => {
                    let timeoutId;
                    const statusDiv = document.getElementById('signing-status');

                    document.getElementById('critical-sign-btn').onclick = async () => {
                        try {
                            statusDiv.textContent = 'üîÑ Solicitando assinatura...';
                            statusDiv.style.color = 'blue';
                            
                            log('üîÑ Iniciando processo de assinatura...');
                            
                            // Transa√ß√£o de teste simples
                            const testTransaction = {
                                feePayer: connectedKey,
                                instructions: [],
                                recentBlockhash: 'TEST_BLOCKHASH_' + Date.now()
                            };

                            log('üìù Chamando window.solana.signTransaction...');
                            const signed = await window.solana.signTransaction(testTransaction);
                            
                            statusDiv.textContent = '‚úÖ Assinatura realizada com sucesso!';
                            statusDiv.style.color = 'green';
                            
                            clearTimeout(timeoutId);
                            
                            setTimeout(() => {
                                document.body.removeChild(overlay);
                                document.head.removeChild(style);
                                resolve(signed);
                            }, 2000);

                        } catch (error) {
                            statusDiv.textContent = `‚ùå Erro: ${error.message}`;
                            statusDiv.style.color = 'red';
                            
                            clearTimeout(timeoutId);
                            
                            setTimeout(() => {
                                document.body.removeChild(overlay);
                                document.head.removeChild(style);
                                reject(error);
                            }, 3000);
                        }
                    };

                    // Timeout de 120 segundos
                    timeoutId = setTimeout(() => {
                        statusDiv.textContent = '‚è∞ Timeout - Teste cancelado ap√≥s 2 minutos';
                        statusDiv.style.color = 'red';
                        
                        setTimeout(() => {
                            if (document.body.contains(overlay)) {
                                document.body.removeChild(overlay);
                                document.head.removeChild(style);
                            }
                            reject(new Error('Timeout - usu√°rio n√£o clicou em 2 minutos'));
                        }, 3000);
                    }, 120000);
                });

                document.getElementById('signing-result').innerHTML = `
                    <div class="result-success">
                        ‚úÖ ASSINATURA BEM-SUCEDIDA!<br>
                        üéâ Phantom abriu e funcionou corretamente<br>
                        üìù Transa√ß√£o assinada com sucesso<br>
                        üîß Sistema funcionando 100%
                    </div>
                `;

                log('‚úÖ TESTE 4 PASSOU: Assinatura realizada com sucesso');
                log('üéâ PHANTOM FUNCIONANDO PERFEITAMENTE!');
                return true;

            } catch (error) {
                document.getElementById('signing-result').innerHTML = `
                    <div class="result-error">
                        ‚ùå FALHA CR√çTICA: ${error.message}<br>
                        üí° Poss√≠veis causas:<br>
                        ‚Ä¢ Popup blocker ativo no browser<br>
                        ‚Ä¢ Phantom travado ou com problema<br>
                        ‚Ä¢ Extens√£o desabilitada<br>
                        ‚Ä¢ Timeout na aprova√ß√£o do usu√°rio<br>
                        ‚Ä¢ Problema de permiss√µes<br><br>
                        üîß <strong>SOLU√á√ïES:</strong><br>
                        1. Desabilite popup blocker<br>
                        2. Reinicie o Phantom<br>
                        3. Recarregue a p√°gina<br>
                        4. Teste em modo inc√≥gnito
                    </div>
                `;

                log(`‚ùå TESTE 4 FALHOU: ${error.message}`);
                log('üö® PROBLEMA CR√çTICO IDENTIFICADO NO PHANTOM!');
                return false;
            }
        }

        async function testPopups() {
            log('ü™ü TESTE 5: Verificando popups...');
            
            try {
                const popup = window.open('', '_blank', 'width=300,height=200');
                
                if (!popup) {
                    throw new Error('Popup bloqueado pelo browser');
                }

                popup.document.write(`
                    <html>
                        <body style="text-align: center; padding: 20px; font-family: Arial;">
                            <h3>‚úÖ Popup Funcionando!</h3>
                            <p>Este popup foi aberto com sucesso.</p>
                            <button onclick="window.close()">Fechar</button>
                        </body>
                    </html>
                `);

                setTimeout(() => popup.close(), 3000);

                document.getElementById('popup-result').innerHTML = `
                    <div class="result-success">
                        ‚úÖ Popups funcionando normalmente<br>
                        ü™ü Teste realizado com sucesso<br>
                        üí° Phantom deve conseguir abrir popups
                    </div>
                `;

                log('‚úÖ TESTE 5 PASSOU: Popups funcionando normalmente');
                return true;

            } catch (error) {
                document.getElementById('popup-result').innerHTML = `
                    <div class="result-error">
                        ‚ùå FALHA: ${error.message}<br>
                        üîß Configure o browser para permitir popups<br>
                        ‚ö†Ô∏è Isso pode estar impedindo o Phantom de abrir
                    </div>
                `;

                log(`‚ùå TESTE 5 FALHOU: ${error.message}`);
                return false;
            }
        }

        async function testBackend() {
            log('üåê TESTE 6: Verificando APIs do backend...');
            
            try {
                const tests = [
                    { name: 'Health', url: 'http://localhost:3001/api/health' },
                    { name: 'Investment Status', url: 'http://localhost:3001/api/investment/status' },
                    { name: 'Pool Discovery', url: 'http://localhost:3001/api/pools/discover?limit=1' }
                ];

                const results = [];

                for (const test of tests) {
                    try {
                        log(`üì° Testando ${test.name}...`);
                        
                        const response = await fetch(test.url, { 
                            signal: AbortSignal.timeout(8000) 
                        });
                        
                        results.push({ 
                            name: test.name, 
                            ok: response.ok, 
                            status: response.status 
                        });
                        
                    } catch (error) {
                        results.push({ 
                            name: test.name, 
                            ok: false, 
                            error: error.message 
                        });
                    }
                }

                const okCount = results.filter(r => r.ok).length;
                const resultText = results.map(r => 
                    `${r.ok ? '‚úÖ' : '‚ùå'} ${r.name}: ${r.ok ? 'OK' : (r.status || 'ERROR')}`
                ).join('<br>');

                document.getElementById('backend-result').innerHTML = `
                    <div class="${okCount === results.length ? 'result-success' : 'result-warning'}">
                        üìä Resultado: ${okCount}/${results.length} APIs funcionando<br>
                        ${resultText}
                    </div>
                `;

                log(`‚úÖ TESTE 6 CONCLU√çDO: ${okCount}/${results.length} APIs OK`);
                return results;

            } catch (error) {
                document.getElementById('backend-result').innerHTML = `
                    <div class="result-error">
                        ‚ùå FALHA: ${error.message}
                    </div>
                `;

                log(`‚ùå TESTE 6 FALHOU: ${error.message}`);
                return false;
            }
        }

        async function runCriticalTest() {
            log('üö® INICIANDO TESTE CR√çTICO COMPLETO...');

            // Executar apenas os testes essenciais para diagn√≥stico
            const criticalTests = [
                { name: 'Detec√ß√£o Phantom', fn: testPhantomDetection },
                { name: 'Conex√£o', fn: testConnection },
                { name: 'Teste Popup', fn: testPopups },
                { name: 'ASSINATURA CR√çTICA', fn: testSigning }
            ];

            const results = [];

            for (const test of criticalTests) {
                try {
                    log(`üîÑ Executando: ${test.name}...`);
                    const result = await test.fn();
                    results.push({ name: test.name, success: !!result });
                    
                    // Pausa entre testes
                    if (test.name !== 'ASSINATURA CR√çTICA') {
                        await new Promise(r => setTimeout(r, 1500));
                    }
                    
                } catch (error) {
                    log(`‚ùå Erro em ${test.name}: ${error.message}`);
                    results.push({ name: test.name, success: false });
                }
            }

            const success = results.filter(r => r.success).length;
            const signingSuccess = results.find(r => r.name === 'ASSINATURA CR√çTICA')?.success;
            
            log(`üéØ RESULTADO FINAL: ${success}/${criticalTests.length} testes passaram`);

            // Relat√≥rio espec√≠fico sobre o problema
            let diagnosis = '';
            if (signingSuccess) {
                diagnosis = '‚úÖ PHANTOM FUNCIONANDO PERFEITAMENTE! Problema resolvido.';
            } else {
                diagnosis = '‚ùå PROBLEMA CONFIRMADO: Phantom n√£o consegue abrir para assinatura.';
            }

            // Mostrar relat√≥rio final
            const report = document.createElement('div');
            report.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid ${signingSuccess ? '#4CAF50' : '#f44336'};
                border-radius: 15px;
                padding: 30px;
                box-shadow: 0 15px 35px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 500px;
                text-align: center;
            `;

            report.innerHTML = `
                <h2>${signingSuccess ? 'üéâ' : 'üö®'} Diagn√≥stico Completo</h2>
                <p style="margin: 20px 0; font-size: 18px; font-weight: bold; color: ${signingSuccess ? 'green' : 'red'};">
                    ${diagnosis}
                </p>
                <div style="text-align: left; margin: 20px 0;">
                    ${results.map(r => `${r.success ? '‚úÖ' : '‚ùå'} ${r.name}`).join('<br>')}
                </div>
                ${!signingSuccess ? `
                    <div style="background: #ffebee; padding: 15px; border-radius: 10px; margin: 20px 0;">
                        <strong>üîß Solu√ß√µes Recomendadas:</strong><br>
                        1. Desabilite popup blocker<br>
                        2. Reinicie a extens√£o Phantom<br>
                        3. Teste em modo inc√≥gnito<br>
                        4. Atualize o Phantom<br>
                        5. Reinicie o browser
                    </div>
                ` : ''}
                <button onclick="this.remove()" style="
                    padding: 15px 30px; 
                    background: ${signingSuccess ? '#4CAF50' : '#f44336'}; 
                    color: white; 
                    border: none; 
                    border-radius: 10px; 
                    cursor: pointer;
                    font-size: 16px;
                    margin-top: 20px;
                ">
                    ${signingSuccess ? 'Perfeito!' : 'Entendi'}
                </button>
            `;

            document.body.appendChild(report);

            log(diagnosis);
        }

        // Inicializar sistema
        window.addEventListener('load', () => {
            updateSystemStatus();
            log('üéØ Sistema de debug cr√≠tico carregado');
            
            // Atualizar status a cada 3 segundos
            setInterval(updateSystemStatus, 3000);
        });

        // Monitorar eventos do Phantom
        if (window.solana) {
            window.solana.on('connect', () => {
                log('üîó Phantom conectado automaticamente');
                updateSystemStatus();
            });
            
            window.solana.on('disconnect', () => {
                log('üîå Phantom desconectado');
                updateSystemStatus();
                connectedKey = null;
                document.getElementById('sign-btn').disabled = true;
            });

            window.solana.on('accountChanged', (publicKey) => {
                if (publicKey) {
                    log(`üîÑ Conta alterada: ${publicKey.toString()}`);
                    connectedKey = publicKey.toString();
                    updateSystemStatus();
                } else {
                    log('üîå Conta desconectada');
                    connectedKey = null;
                    document.getElementById('sign-btn').disabled = true;
                }
            });
        }
    </script>
</body>
</html>
